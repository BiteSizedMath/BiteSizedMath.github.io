<!DOCTYPE html>

<html>

<head>
    <script>
        MathJax = {
            loader: { load: ['input/asciimath', 'output/chtml', 'ui/menu'] },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    MathJax.startup.promise.then(() => {
                        window.init();
                    });
                },
            }
        };
    </script>
    <script id='MathJax-script' async src='https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js'></script>
    <script src=" https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js "></script>
    <script src='problemgenerator.js'></script>

    <style>
        body {
            text-align: center;
            padding: 5rem;
            box-sizing: border-box;
            font-size: 3rem;
            background-color: black;
            color: white;
        }

        mjx-container {
            font-size: 1em !important;
        }

        div {
            padding: 1rem;
        }

        textarea {
            background-color: black;
            color: white;
            border: 1px solid white;
        }

        #stats {
            padding: 1rem;
            font-size: 1rem;
            position: absolute;
            left: 0;
            top: 0;
            font-family: monospace;
            text-align: start;
        }

        #feedback>div {
            display: flex;
            justify-content: space-around;
        }

        button {
            background-color: black;
            color: white;
            padding: 1rem;
            font-size: 2rem;
            border: 1px solid white;
            width: 50%;
            cursor: pointer;
        }
    </style>
</head>

<body onclick='window.onBodyClicked()' style="min-width: 100vw; min-height:100vh;">

    <script type="module">
        import { initRandom, rand } from './randutils.js';
        import {
            generateCombineSum,
            generateCombineSumN,
            generateFactorOut,
            generateReduceSimpleFraction,
            generateReduceFractionSimpleDenominator,
            generateExpandFactoredTermSum,
            generateExpandTermSumProduct,
            generateAddFractionSimple,
            generateAddFraction,
            generateSeparateFraction,
        } from './problemgenerator.js';
        import { getStats, recordPlayed } from './stats.js';

        let step = 0;
        let hideProblemWhenDone = true;

        function filterDuplicateSteps(steps, problem, solution) {
            problem = problem.replaceAll('=', '').trim().replaceAll(' ', '');
            solution = solution.replaceAll('=', '').trim().replaceAll(' ', '');
            let filtered = [];
            for (let step of steps) {
                const trimmedStep = step.replaceAll('=', '').trim().replaceAll(' ', '');
                if (trimmedStep === problem || trimmedStep === solution)
                    continue;
                if (filtered.length > 0 && filtered[filtered.length - 1] === step)
                    continue;
                filtered.push(step);
            }
            return filtered;
        }

        async function renderRandom() {
            initRandom();

            const generators = [
                generateCombineSum,
                generateCombineSumN,
                generateFactorOut,
                generateReduceSimpleFraction,
                generateReduceFractionSimpleDenominator,
                generateExpandFactoredTermSum,
                generateExpandTermSumProduct,
                generateAddFractionSimple,
                generateAddFraction,
                generateSeparateFraction,
            ]

            let { prompt, problem, solution, steps } = generators[rand(generators.length)]();
            if (solution === '')
                solution = '0';

            document.getElementById('prompt').innerHTML = prompt;
            document.getElementById('problem').innerHTML = '`' + problem + '`';
            if (problem.includes('?')) {
                document.getElementById('solution').innerHTML = '`' + problem.replace('?', solution) + '`';
                hideProblemWhenDone = true;
            }
            else {
                document.getElementById('solution').innerHTML = '`' + solution + '`';
                hideProblemWhenDone = false;
            }

            if (steps) {
                steps = filterDuplicateSteps(steps, problem, solution);
                for (let step of steps) {
                    document.getElementById('steps').innerHTML += '<div style="display: none;">`' + step + '`</div>';
                }
            }

            await MathJax.typesetPromise();
        }

        window.newProblem = (wasCorrect) => {
            step = 0;
            document.getElementById('problem').style.display = 'block';
            document.getElementById('steps').innerHTML = '';
            document.getElementById('notes').value = '';
            document.getElementById('solution').style.display = 'none';
            document.getElementById('feedback').style.display = 'none';
            recordPlayed(wasCorrect);
            refreshStats();
            renderRandom();
        }

        window.onBodyClicked = () => {
            if (step > document.getElementById('steps').childElementCount)
                return;
            step++;

            if (step > document.getElementById('steps').childElementCount) {
                if (hideProblemWhenDone)
                    document.getElementById('problem').style.display = 'none';
                document.getElementById('solution').style.display = 'block';
                document.getElementById('feedback').style.display = 'block';
            } else {
                document.getElementById('steps').children[step - 1].style.display = 'block';
            }
        }
        window.init = () => {
            refreshStats();
            renderRandom();
        }

        function refreshStats() {
            const stats = getStats();
            document.getElementById('stats').innerHTML = `
                Played: ${stats.totalSolvedCorrect} / ${stats.totalSolved}<br>
                Today: ${stats.solvedTodayCorrect} / ${stats.solvedToday}`;
        }

    </script>

    <div id="prompt"></div>
    <div id="problem" style="display: block;"> </div>
    <div id="steps" style="display: block;"> </div>
    <div id="solution" style="display: none;"> </div>
    <div id="feedback" style="display: none;">
        <div>
            <button onclick="event.stopPropagation();newProblem(false)">X</button>
            <button onclick="event.stopPropagation();newProblem(true)">âœ”</button>
        </div>
    </div>

    <textarea id="notes" style="width: 100%; height: 10rem; font-size: 1rem; margin-top: 1rem;" placeholder="Notes"
        onclick="event.stopPropagation()"></textarea>

    <div id="stats"></div>

</body>

</html>