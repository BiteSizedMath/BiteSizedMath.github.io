<!DOCTYPE html>

<html>

<head>
    <script>
        MathJax = {
            loader: { load: ['input/asciimath', 'output/chtml', 'ui/menu'] },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    MathJax.startup.promise.then(() => {
                        window.onBodyClicked();
                    });
                },
            }
        };
    </script>
    <script id='MathJax-script' async src='https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js'></script>
    <script src='problemgenerator.js'></script>

    <style>
        body {
            text-align: center;
            padding: 5rem;
            box-sizing: border-box;
            font-size: 3rem;
            background-color: black;
            color: white;
        }

        mjx-container {
            font-size: 1em !important;
        }

        div {
            padding: 1rem;
        }

        #solution {
            border: 1px solid white;
        }

        textarea {
            background-color: black;
            color: white;
            border: 1px solid white;
        }
    </style>
</head>

<body onclick='window.onBodyClicked()' style="min-width: 100vw; min-height:100vh;">

    <script type="module">
        import { initRandom, rand } from './randutils.js';
        import {
            generateCombineSum,
            generateCombineSumN,
            generateFactorOut,
            generateReduceSimpleFraction,
            generateReduceFractionSimpleDenominator,
            generateExpandFactoredTermSum,
            generateExpandTermSumProduct,
            generateAddFractionSimple,
            generateAddFraction,
            generateSeparateFraction,
        } from './problemgenerator.js';

        let state = -1;
        let hideProblem = true;

        function filterDuplicateSteps(steps, problem, solution) {
            problem = problem.replaceAll('=', '').trim().replaceAll(' ', '');
            solution = solution.replaceAll('=', '').trim().replaceAll(' ', '');
            let filtered = [];
            for (let step of steps) {
                const trimmedStep = step.replaceAll('=', '').trim().replaceAll(' ', '');
                if (trimmedStep === problem || trimmedStep === solution)
                    continue;
                if (filtered.length > 0 && filtered[filtered.length - 1] === step)
                    continue;
                filtered.push(step);
            }
            return filtered;
        }

        async function renderRandom() {
            initRandom();

            const generators = [
                generateCombineSum,
                generateCombineSumN,
                generateFactorOut,
                generateReduceSimpleFraction,
                generateReduceFractionSimpleDenominator,
                generateExpandFactoredTermSum,
                generateExpandTermSumProduct,
                generateAddFractionSimple,
                generateAddFraction,
                generateSeparateFraction,
            ]

            let { prompt, problem, solution, steps } = generators[rand(generators.length)]();
            if (solution === '')
                solution = '0';

            document.getElementById('prompt').innerHTML = prompt;
            document.getElementById('problem').innerHTML = '`' + problem + '`';
            if (problem.includes('?')) {
                document.getElementById('solution').innerHTML = '`' + problem.replace('?', solution) + '`';
                hideProblem = true;
            }
            else {
                document.getElementById('solution').innerHTML = '`' + solution + '`';
                hideProblem = false;
            }

            if (steps) {
                steps = filterDuplicateSteps(steps, problem, solution);
                for (let step of steps) {
                    document.getElementById('steps').innerHTML += '<div style="display: none;">`' + step + '`</div>';
                }
            }

            await MathJax.typesetPromise();
        }

        function onBodyClicked() {
            state = (state + 1) % (2 + document.getElementById('steps').childElementCount);
            if (state == 0) {
                document.getElementById('problem').style.display = 'block';
                document.getElementById('steps').innerHTML = '';
                document.getElementById('notes').value = '';
                document.getElementById('solution').style.display = 'none';
                renderRandom();
            } else if (document.getElementById('steps').childElementCount >= state) {
                document.getElementById('steps').children[state - 1].style.display = 'block';
            } else {
                if (hideProblem)
                    document.getElementById('problem').style.display = 'none';
                document.getElementById('solution').style.display = 'block';
            }
        }
        window.onBodyClicked = onBodyClicked;
    </script>

    <div id="prompt"></div>
    <div id="problem" style="display: block;"> </div>
    <div id="steps" style="display: block;"> </div>
    <div id="solution" style="display: none;"> </div>

    <textarea id="notes" style="width: 100%; height: 10rem; font-size: 1rem; margin-top: 1rem;" placeholder="Notes" onclick="event.stopPropagation()"></textarea>

</body>

</html>